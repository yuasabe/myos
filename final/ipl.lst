     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  
     4                                  CYLS	EQU 10
     5                                  
     6                                  ORG	0x7c00
     7                                  
     8                                  ; FAT12 FD
     9                                  
    10 00000000 EB4E                    JMP	entry
    11                                  
    12 00000002 90                      DB	0x90
    13 00000003 48454C4C4F49504C        DB	"HELLOIPL"
    14 0000000B 0002                    DW	512
    15 0000000D 01                      DB	1
    16 0000000E 0100                    DW	1
    17 00000010 02                      DB	2
    18 00000011 E000                    DW	224
    19 00000013 400B                    DW	2880
    20 00000015 F0                      DB	0xf0
    21 00000016 0900                    DW	9
    22 00000018 1200                    DW	18
    23 0000001A 0200                    DW	2
    24 0000001C 00000000                DD	0
    25 00000020 400B0000                DD	2880
    26 00000024 000029                  DB	0, 0, 0x29
    27 00000027 FFFFFFFF                DD	0xffffffff
    28 0000002B 48454C4C4F2D4F5320-     DB	"HELLO-OS   "
    28 00000034 2020               
    29 00000036 4641543132202020        DB	"FAT12   "
    30                                  ;RESB 18
    31 0000003E 00<rept>                TIMES 18 DB 0
    32                                  
    33                                  ; Program
    34                                  
    35                                  entry:
    36 00000050 B80000                  	MOV		AX, 0
    37 00000053 8ED0                    	MOV		SS, AX
    38 00000055 BC007C                  	MOV		SP, 0x7c00
    39 00000058 8ED8                    	MOV		DS, AX		; data segment
    40 0000005A 8EC0                    	MOV		ES, AX		; extra segment
    41                                  
    42 0000005C BE[C500]                	MOV		SI, msg
    43                                  
    44                                  ; ディスクを読む
    45                                  
    46 0000005F B82008                  	MOV		AX,0x0820
    47 00000062 8EC0                    	MOV		ES,AX
    48 00000064 B500                    	MOV		CH,0			; シリンダ0
    49 00000066 B600                    	MOV		DH,0			; ヘッド0
    50 00000068 B102                    	MOV		CL,2			; セクタ2
    51                                  
    52                                  readloop:
    53 0000006A BE0000                  	MOV		SI,0			; 失敗回数を数えるレジスタ
    54                                  
    55                                  retry:
    56 0000006D B402                    	MOV		AH,0x02			; AH=0x02 : ディスク読み込み
    57 0000006F B001                    	MOV		AL,1			; 1セクタ
    58 00000071 BB0000                  	MOV		BX,0
    59 00000074 B200                    	MOV		DL,0x00			; Aドライブ
    60 00000076 CD13                    	INT		0x13			; ディスクBIOS呼び出し
    61 00000078 7310                    	JNC		next				; エラーが起きなければnextへ
    62 0000007A 83C601                  	ADD		SI,1
    63 0000007D 83FE05                  	CMP		SI,5
    64 00000080 732E                    	JAE		error			; SI >= 5だったらerrorへ
    65 00000082 B400                    	MOV		AH, 0x00
    66 00000084 B200                    	MOV		DL, 0x00
    67 00000086 CD13                    	INT		0x13			; ドライブのリセット
    68 00000088 EBE3                    	JMP		retry
    69                                  
    70                                  next:
    71 0000008A 8CC0                    	MOV		AX,ES			; アドレスを0x200進める
    72 0000008C 83C020                  	ADD		AX,0x0020
    73 0000008F 8EC0                    	MOV		ES,AX
    74 00000091 80C101                  	ADD		CL,1
    75 00000094 80F912                  	CMP 	CL,18
    76 00000097 76D1                    	JBE		readloop	; CL <= 18 だったらreadloopへ
    77 00000099 B101                    	MOV		CL,1
    78 0000009B 80C601                  	ADD		DH,1
    79 0000009E 80FE02                  	CMP		DH,2
    80 000000A1 72C7                    	JB		readloop	; DH < 2だったらreadloopへ
    81 000000A3 B600                    	MOV		DH,0
    82 000000A5 80C501                  	ADD		CH,1
    83 000000A8 80FD0A                  	CMP		CH,CYLS
    84 000000AB 72BD                    	JB		readloop
    85                                  
    86                                  fin:
    87 000000AD F4                      	HLT
    88 000000AE EBFD                    	JMP fin
    89                                  
    90                                  error:
    91 000000B0 BE[C500]                	MOV		SI,msg
    92                                  
    93                                  putloop:
    94 000000B3 8A04                    	MOV		AL, [SI]
    95 000000B5 83C601                  	ADD		SI, 1
    96 000000B8 3C00                    	CMP		AL, 0
    97 000000BA 74F1                    	JE		fin
    98 000000BC B40E                    	MOV		AH, 0x0e	; 1文字表示
    99 000000BE BB0F00                  	MOV		BX, 15		; カラーコード
   100 000000C1 CD10                    	INT		0x10 		; ビデオBIOS呼び出し
   101 000000C3 EBEE                    	JMP putloop
   102                                  
   103                                  msg:
   104 000000C5 0A0A                    	DB		0x0a, 0x0a ; 改行2行
   105 000000C7 6C6F6164206572726F-     	DB		"load error"
   105 000000D0 72                 
   106 000000D1 0A                      	DB		0x0a
   107 000000D2 00                      	DB		0
   108                                  	; RESB 	0x1fe-$
   109 000000D3 00<rept>                	TIMES	0x1fe-($-$$) DB 0
   110 000001FE 55AA                    	DB		0x55, 0xaa
   111                                  	; PCはまずディスクの最初のセクタを読み、その最後の2バイトを見る。それが55AAであればboot sectorと認識する。
